<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>pgqueue.core documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Pgqueue</span> <span class="project-version">0.5.1</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pgqueue</span></div></div></li><li class="depth-2 branch current"><a href="pgqueue.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>serializer</span></div></div></li><li class="depth-3 branch"><a href="pgqueue.serializer.fressian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fressian</span></div></a></li><li class="depth-3 branch"><a href="pgqueue.serializer.nippy.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>nippy</span></div></a></li><li class="depth-3"><a href="pgqueue.serializer.protocol.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>protocol</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="pgqueue.core.html#var-count"><div class="inner"><span>count</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-count-deleted"><div class="inner"><span>count-deleted</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-delete"><div class="inner"><span>delete</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-delete-and-unlock"><div class="inner"><span>delete-and-unlock</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-destroy-all-queues.21"><div class="inner"><span>destroy-all-queues!</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-destroy-queue.21"><div class="inner"><span>destroy-queue!</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-locking-take"><div class="inner"><span>locking-take</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-locking-take-batch"><div class="inner"><span>locking-take-batch</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-purge-deleted"><div class="inner"><span>purge-deleted</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-put"><div class="inner"><span>put</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-put-batch"><div class="inner"><span>put-batch</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-queue"><div class="inner"><span>queue</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-take"><div class="inner"><span>take</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-take-batch"><div class="inner"><span>take-batch</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-take-with"><div class="inner"><span>take-with</span></div></a></li><li class="depth-1"><a href="pgqueue.core.html#var-unlock"><div class="inner"><span>unlock</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">pgqueue.core</h1><div class="doc"><pre class="plaintext"></pre></div><div class="public anchor" id="var-count"><h3>count</h3><div class="usage"><code>(count q)</code></div><div class="doc"><pre class="plaintext">Count the items in queue.
</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L588">view source</a></div></div><div class="public anchor" id="var-count-deleted"><h3>count-deleted</h3><div class="usage"><code>(count-deleted q)</code></div><div class="doc"><pre class="plaintext">Count the deleted items in queue.
These rows only exist when the :delete
behavior in pgqueue/queue's config is set
to false.</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L605">view source</a></div></div><div class="public anchor" id="var-delete"><h3>delete</h3><div class="usage"><code>(delete item)</code></div><div class="doc"><pre class="plaintext">Delete a PGQueueItem item from queue.
Delete behavior is controlled by the
queue config option :delete in pgqueue/queue.
If true, this actually deletes rows,
otherwise, it sets the "deleted" flag to true.
Returns boolean if a row was deleted.

usage: (delete item)</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L473">view source</a></div></div><div class="public anchor" id="var-delete-and-unlock"><h3>delete-and-unlock</h3><div class="usage"><code>(delete-and-unlock locked-item)</code></div><div class="doc"><pre class="plaintext">Delete and unlock a PGQueueLockedItem.
This is a convenience function wrapping
pgqueue/delete and pgqueue/unlock.
Returns boolean "and" of above functions.

usage: (delete-and-unlock locked-item)</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L510">view source</a></div></div><div class="public anchor" id="var-destroy-all-queues.21"><h3>destroy-all-queues!</h3><div class="usage"><code>(destroy-all-queues! config)</code></div><div class="doc"><pre class="plaintext">Drop the queue table, then unlock any existing advisory locks.
This function takes the same config hashmap used in pgqueue/queue.</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L217">view source</a></div></div><div class="public anchor" id="var-destroy-queue.21"><h3>destroy-queue!</h3><div class="usage"><code>(destroy-queue! q)</code></div><div class="doc"><pre class="plaintext">Unlocks any existing advisory locks for rows of this queue's
table and deletes all rows for the queue from the queue table.</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L210">view source</a></div></div><div class="public anchor" id="var-locking-take"><h3>locking-take</h3><div class="usage"><code>(locking-take q)</code></div><div class="doc"><pre class="plaintext">Lock and take item, returning a PGQueueLockedItem.

usage: (locking-take q)

example: (let [locked-item (pgqueue/locking-take q)]
            ; do some work here with item
            (pgqueue/delete-and-unlock locked-item))
            
It is expected that pgqueue/delete and pgqueue/unlock 
will later be called on the returned item and lock,
respectively.

See the pgqueue/take-with macro, which wraps up the
use case for takers doing work and then deleting
the item only after the work is safely completed.</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L354">view source</a></div></div><div class="public anchor" id="var-locking-take-batch"><h3>locking-take-batch</h3><div class="usage"><code>(locking-take-batch q n)</code></div><div class="doc"><pre class="plaintext">Lock and take a batch of up to n items from queue.
Returns a sequence of PGQueueLockedItem instances.

usage: (locking-take-batch q n)

It is expected that pgqueue/delete and pgqueue/unlock 
will later be called on each of the items and locks
in the PGQeueuLockedItems returned.</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L412">view source</a></div></div><div class="public anchor" id="var-purge-deleted"><h3>purge-deleted</h3><div class="usage"><code>(purge-deleted q)</code></div><div class="doc"><pre class="plaintext">Purge deleted rows for the given queue.
These rows only exist when the :delete
behavior in pgqueue/queue's config is set
to false.
Returns number of rows deleted.</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L621">view source</a></div></div><div class="public anchor" id="var-put"><h3>put</h3><div class="usage"><code>(put q item)</code><code>(put q priority item)</code></div><div class="doc"><pre class="plaintext">Put item onto queue.

usage: (put q item)
       (put q priority item)

Returns true on success, false on failure, nil on no-op.

item can be any serializable Clojure data.

When item is nil, put is a no-op and returns nil.

For arity of 2, a default priority is used.
For arity of 3, the second argument is a priority integer
where a lower value = higher priority; negative integers 
are also accepted.

Examples:
(pgq/put q -10 "urgent")
(pgq/put q 1   "high")
(pgq/put q 100 "medium/default")
(pgq/put q 200 "low")
(pgq/put q 500 "least")</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L277">view source</a></div></div><div class="public anchor" id="var-put-batch"><h3>put-batch</h3><div class="usage"><code>(put-batch q batch)</code><code>(put-batch q priority batch)</code></div><div class="doc"><pre class="plaintext">Put batch of items onto queue.

usage: (put q batch)
       (put q priority batch)

Returns true on success, false on failure.

batch is a sequence items.
An item can be any serializable Clojure data.

When an item in the batch is nil, it is removed from
the batch. (put q nil) is a no-op, so put-batch does
likewise.

For arity of 2, a default priority is used.
For arity of 3, the second argument is a priority integer
where a lower value = higher priority; negative integers 
are also accepted.  All items of the batch will have the
same priority.</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L314">view source</a></div></div><div class="public anchor" id="var-queue"><h3>queue</h3><div class="usage"><code>(queue name config)</code></div><div class="doc"><pre class="plaintext">Specify a queue with a name and a config.  
Creates the underlying queue table if it
does not yet exist.

- name can be a keyword or string   
- config is a hashmap with the following keys:
    :db - clojure.java.jdbc db-spec

  and optional keys:
    :schema - schema name (default is "public"
    :table  - table name (default is "pgqueues")
    :delete - delete behavior upon successful take:
              - true (default) deletes queue item row
              - false sets a deleted_flag to true
                (persists all queue items; see pgqueue/purge-deleted)
    :default-priority - default priority for puts not specifying
                        a priority; must be an integer
                        where a lower value = higher priority; negative integers 
                        are also accepted
    :analyze-threshold - run a 'vacuum analyze' on queue table when this number
                         of put/put-batch items is hit. 0 disables this feature.
                         default value is 0 (disabled).
    :serializer - instance of a type that implements
                  pgqueue.serializer.Serializer protocol
                    default is instance of pgqueue.serializer.nippy/NippySerializer
                    (pgqueue.serializer.fressian/FressianSerializer is available, too)</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L243">view source</a></div></div><div class="public anchor" id="var-take"><h3>take</h3><div class="usage"><code>(take q)</code></div><div class="doc"><pre class="plaintext">Take item off queue.
Returns nil if no item available.

usage: (take q)

item is retrieved from the queue with the sort order:
 - priority (low number = high priority)
 - inserted order

This function uses Postgresql's advisory locks 
to ensure that only one taker gains access to the item,
such that multiple takers can pull items from the queue
without the fear of another taker pulling the same item.

The item is retrieved from the queue with an advisory lock, 
deleted (see pgqueue/queue for delete behavior), unlocked, 
and returned.

Also see pgqueue/take-with for use cases requiring the
item to only be removed from the queue after successfully
completing work.</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L522">view source</a></div></div><div class="public anchor" id="var-take-batch"><h3>take-batch</h3><div class="usage"><code>(take-batch q n)</code></div><div class="doc"><pre class="plaintext">Take batch up to n items off queue.
Returns seq of items.

usage: (take-batch q n)

item in batch are retrieved from the queue with the sort order:
 - priority (low number = high priority)
 - inserted order</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L549">view source</a></div></div><div class="public anchor" id="var-take-with"><h3>take-with</h3><h4 class="type">macro</h4><div class="usage"><code>(take-with binding &amp; body)</code></div><div class="doc"><pre class="plaintext">Lock and take an item off queue, bind the taken item, 
execute the body, and ensure delete and unlock after body.

usage: (take-with [binding &amp; body])

binding takes the form [item q], where
item is the binding name, and q is the queue.

This macro uses Postgresql's advisory locks 
to ensure that only one taker gains access to the item,
such that multiple takers can pull items from the queue
without the fear of another taker pulling the same item.</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L566">view source</a></div></div><div class="public anchor" id="var-unlock"><h3>unlock</h3><div class="usage"><code>(unlock lock)</code></div><div class="doc"><pre class="plaintext">Unlock a PGQueueLock.
Returns boolean.

usage: (unlock lock)</pre></div><div class="src-link"><a href="http://github.com/layerware/pgqueue/blob/0.5.1/src/pgqueue/core.clj#L493">view source</a></div></div></div></body></html>